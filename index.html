<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ChatGPT5 Mini + Talking JokeBox</title>
<style>
body { font-family:sans-serif; margin:0; padding:0; display:flex; flex-direction:column; min-height:100vh; background:#f8fafc; }
header, footer { background:#2575fc; color:white; padding:12px 20px; text-align:center; }
main { flex:1; display:flex; flex-direction:column; gap:12px; padding:12px 20px; }
#chat-log, #joke-log { flex:1; overflow:auto; display:flex; flex-direction:column; gap:6px; border:1px solid #ddd; padding:8px; border-radius:8px; background:#fff; box-shadow:0 2px 5px rgba(0,0,0,0.1);}
.message, .joke { max-width:80%; padding:8px 12px; border-radius:10px; font-size:1rem; }
.user { align-self:flex-end; background:#2575fc; color:white; }
.ai, .joke-ai { align-self:flex-start; background:#e0e0e0; color:#222; }
#input-bar, #joke-bar { display:flex; gap:8px; margin-top:8px; }
input, select { flex:1; padding:8px; font-size:1rem; }
button { padding:8px 12px; cursor:pointer; border:none; border-radius:6px; background:#2575fc; color:white; font-weight:600; }
</style>
</head>
<body>

<header>
<h1>ChatGPT5 Mini + Talking JokeBox</h1>
<p>AI chat and jokes, typed and read aloud like a real conversation!</p>
</header>

<main>
  <!-- Chat Section -->
  <section>
    <h2>Chat with AI</h2>
    <div id="chat-log"></div>
    <div id="input-bar">
      <input type="text" id="user-input" placeholder="Type your message"/>
      <button id="send">Send</button>
    </div>
  </section>

  <!-- Joke Section -->
  <section>
    <h2>Random Joke</h2>
    <div id="joke-log"></div>
    <div id="joke-bar">
      <select id="category">
        <option value="Any">Any</option>
        <option value="Programming">Programming</option>
        <option value="Misc">Misc</option>
        <option value="Dark">Dark</option>
        <option value="Pun">Pun</option>
      </select>
      <button id="get-joke">Get Joke</button>
    </div>
  </section>
</main>

<footer>
<small>Jokes powered by JokeAPI, with cinematic speech and typewriter effect!</small>
</footer>

<script>
// --- Utilities ---
function appendMessage(container,text,cls){ 
  const div=document.createElement('div'); 
  div.className=cls; 
  div.textContent=''; // will type dynamically
  container.appendChild(div); 
  div.scrollIntoView({behavior:'smooth'});
  return div;
}

let synth = window.speechSynthesis;

// --- Function to speak with natural pauses ---
async function speakCinematic(text){
  if(synth.speaking) synth.cancel();
  let i=0;
  const chunkSize=30;
  while(i<text.length){
    let chunk = text.slice(i,i+chunkSize);
    let utter = new SpeechSynthesisUtterance(chunk);
    utter.rate = 1; 
    utter.pitch = 1;
    synth.speak(utter);
    await new Promise(r=>setTimeout(r,chunk.length*30)); // delay based on characters
    i+=chunkSize;
  }
}

// --- Typewriter effect with live speech ---
async function typeAndSpeak(text, container){
  container.textContent='';
  for(let i=0;i<text.length;i++){
    container.textContent+=text[i];
    container.scrollIntoView({behavior:'smooth'});
    // small pause and speak partial
    if(text[i]===' ' || text[i]==='.' || text[i]==',' || text[i]==='!'){
      const partial = container.textContent;
      const utter = new SpeechSynthesisUtterance(partial.slice(-30));
      utter.rate=1; utter.pitch=1;
      synth.speak(utter);
    }
    await new Promise(r=>setTimeout(r,25 + Math.random()*25)); // jittered for realistic typing
  }
}

// --- ChatGPT ---
const chatLog=document.getElementById('chat-log');
const input=document.getElementById('user-input');
const sendBtn=document.getElementById('send');

async function sendMessage(){
  const msg=input.value.trim(); if(!msg) return;
  appendMessage(chatLog,msg,'user'); 
  input.value='';
  const aiDiv=appendMessage(chatLog,'','ai');

  try{
    const res = await fetch('/api/chat',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({message:msg})
    });
    const data = await res.json();
    await typeAndSpeak(data.reply||'Oops, no reply',aiDiv);
  } catch(err){
    aiDiv.textContent=`⚠️ Error: ${err}`;
  }
}

sendBtn.addEventListener('click',sendMessage);
input.addEventListener('keypress',e=>{ if(e.key==='Enter') sendMessage(); });

// --- JokeBox ---
const jokeLog=document.getElementById('joke-log');
const getJokeBtn=document.getElementById('get-joke');
const categorySelect=document.getElementById('category');

async function fetchJoke(){
  const cat=categorySelect.value;
  try{
    const res=await fetch(`https://v2.jokeapi.dev/joke/${cat}`);
    const data=await res.json();
    let text='';
    if(data.type==='single'){ text=data.joke; }
    else{ text=data.setup+' ... '+data.delivery; }
    const jokeDiv=appendMessage(jokeLog,'','joke-ai');
    await typeAndSpeak(text,jokeDiv);
  } catch(err){
    appendMessage(jokeLog,'⚠️ Could not fetch joke','joke-ai');
  }
}

getJokeBtn.addEventListener('click',fetchJoke);
</script>

</body>
</html>
